<div class="max-w-xl mx-auto p-6 overflow-y-scroll h-screen pb-20">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">ğŸš¨ Report an emergency</h1>

  <!-- Loading -->
  <div *ngIf="checkingLocation" class="text-gray-600 text-sm mb-4">
    ğŸ“ Fetching your location...
  </div>
  <div *ngIf="loadingIncidents" class="text-gray-600 text-sm mb-4">
    ğŸ”„ Loading nearby incidents...
  </div>

  <!-- Existing incidents -->
  <div
    *ngIf="!loadingIncidents && nearbyIncidents.length > 0"
    class="bg-gray-50 p-4 rounded-md border border-gray-200 mb-5"
  >
    <h2 class="text-lg font-semibold text-gray-700 mb-2">
      Nearby Incidents (last 1 hour)
    </h2>

    <div *ngFor="let inc of nearbyIncidents" class="border-b border-gray-200 py-3">
      <div class="flex flex-col space-y-1">
        <p class="text-sm text-gray-800 font-medium">
          {{ inc.description }}
        </p>
        <p class="text-xs text-gray-500">
          Reported {{ inc.createdAt | date: 'short' }}
        </p>
      </div>

      <!-- Photos -->
      <div *ngIf="inc.photos && inc.photos.length" class="flex flex-wrap gap-2 mt-2">
        <img
          *ngFor="let photo of inc.photos"
          [src]="photo"
          (click)="openPhoto(photo)"
          alt="Incident photo"
          class="w-20 h-20 object-cover rounded-md border border-gray-300 cursor-pointer hover:scale-105 transition-transform"
        />
      </div>

      <div *ngIf="!inc.photos || inc.photos.length === 0" class="text-xs text-gray-400 mt-1">
        ğŸ“· No photos uploaded yet
      </div>

      <!-- Select Checkbox -->
      <div class="mt-3">
        <button
          (click)="toggleIncidentSelection(inc._id)"
          [ngClass]="
            selectedIncidentId === inc._id
              ? 'bg-green-700 text-white'
              : 'bg-gray-300 text-gray-800'
          "
          class="px-3 py-1 rounded-md text-sm font-medium"
        >
          {{ selectedIncidentId === inc._id ? 'âœ… Selected' : 'Select This Incident' }}
        </button>
      </div>
    </div>
  </div>

  <!-- No incidents -->
  <p
    *ngIf="!loadingIncidents && nearbyIncidents.length === 0 && !error"
    class="text-sm text-gray-600 mb-5"
  >
    No active incidents near you. You can report a new one below.
  </p>

  <!-- Form -->
  <form [formGroup]="incidentForm" (submit)="$event.preventDefault()" class="space-y-5">
    <!-- Description field (always visible) -->
    <div>
      <label class="block mb-1 text-gray-700 font-medium">Description / Update</label>
      <textarea
        formControlName="description"
        rows="4"
        placeholder="Describe what happened or provide an update..."
        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-600 focus:border-transparent"
      ></textarea>
    </div>

    <!-- File Upload -->
    <div>
      <label class="block mb-1 text-gray-700 font-medium">
        {{ selectedIncidentId ? 'Upload Additional Media' : 'Upload Photos' }}
      </label>
      <app-file-uploader
        (uploadSuccessfulEvent)="onImageUploaded($event)"
        (uploadErrorEvent)="onUploadError()"
      ></app-file-uploader>
    </div>

    <!-- Preview -->
    <div *ngIf="photoUrls.length > 0" class="grid grid-cols-3 gap-3 mt-4">
      <div *ngFor="let photo of photoUrls" class="relative group">
        <img [src]="photo" class="w-full h-32 object-cover rounded-lg border border-gray-300" />
        <button
          type="button"
          (click)="removePhoto(photo)"
          class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-80 hover:opacity-100"
        >
          &times;
        </button>
      </div>
    </div>

 <!-- Responder Selector (only for new incidents) -->
<div *ngIf="!selectedIncidentId" class="mt-4">
  <label class="block mb-1 text-gray-700 font-medium">
    Maximum Number of Responders Needed
  </label>

  <input
    type="range"
    min="1"
    max="10"
    step="1"
    formControlName="maxResponders"
    class="w-full accent-green-700"
  />

  <div class="text-center text-sm text-gray-600 mt-1">
    {{ incidentForm.get('maxResponders')?.value }} responder
    {{ incidentForm.get('maxResponders')?.value > 1 ? 's' : '' }} needed
  </div>
</div>


    <!-- Submit -->
    <button
      [disabled]="submitting || (incidentForm.invalid && !selectedIncidentId)"
      (click)="submitIncident()"
      class="w-full bg-green-700 text-white py-2 px-4 rounded-lg font-semibold shadow hover:bg-green-800 disabled:opacity-50 transition"
    >
      <span *ngIf="!submitting">
        {{ selectedIncidentId ? 'Add to Existing Incident' : 'Create New Incident' }}
      </span>
      <div *ngIf="submitting" class="flex justify-center items-center space-x-2">
        <svg
          class="animate-spin h-5 w-5 text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <span>Submitting...</span>
      </div>
    </button>
  </form>

  <!-- Messages -->
  <p *ngIf="message" class="text-green-700 mt-4 text-sm font-medium">{{ message }}</p>
  <p *ngIf="error" class="text-red-600 mt-2 text-sm font-medium">{{ error }}</p>
</div>
