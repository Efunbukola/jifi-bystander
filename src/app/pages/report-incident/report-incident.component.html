<div class="max-w-xl mx-auto p-6">
  <h1 class="text-2xl font-bold text-gray-800 mb-4">üö® Report or Add to Incident</h1>

  <!-- Step 1: Check existing -->
  <div class="mb-4">
    <button
      (click)="checkNearbyIncidents()"
      [disabled]="checkingNearby"
      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium w-full"
    >
      <span *ngIf="!checkingNearby">üîç Check Nearby Incidents</span>
      <span *ngIf="checkingNearby">Checking...</span>
    </button>
  </div>

  <!-- Existing Incidents -->
  <div *ngIf="showExistingList" class="bg-gray-50 p-4 rounded-md border border-gray-200 mb-5">
    <h2 class="text-lg font-semibold text-gray-700 mb-2">Existing Reports Nearby</h2>

    <div *ngFor="let inc of nearbyIncidents" class="border-b border-gray-200 py-2">
      <p class="text-sm text-gray-700">
        <strong>{{ inc.description }}</strong>
      </p>
      <p class="text-xs text-gray-500">
        Reported on {{ inc.createdAt | date: 'short' }}
      </p>

      <button
        (click)="selectedIncidentId = inc._id"
        [ngClass]="
          selectedIncidentId === inc._id
            ? 'bg-green-700 text-white'
            : 'bg-gray-300 text-gray-800'
        "
        class="px-3 py-1 rounded-md text-sm font-medium mt-2"
      >
        {{ selectedIncidentId === inc._id ? '‚úÖ Selected' : 'Add Media' }}
      </button>
    </div>

    <p *ngIf="!nearbyIncidents.length" class="text-sm text-gray-500 mt-2">
      No incidents found nearby.
    </p>
  </div>

  <!-- Step 2: Form -->
  <form [formGroup]="incidentForm" (ngSubmit)="submitIncident()" class="space-y-5">
    <!-- Description (hide if adding to existing) -->
    <div *ngIf="!selectedIncidentId">
      <label class="block mb-1 text-gray-700 font-medium">Incident Description</label>
      <textarea
        formControlName="description"
        rows="4"
        placeholder="Describe what happened..."
        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-600 focus:border-transparent"
      ></textarea>

      <p
        *ngIf="
          incidentForm.get('description')?.invalid &&
          incidentForm.get('description')?.touched
        "
        class="text-red-500 text-sm mt-1"
      >
        A brief description is required (min 10 characters).
      </p>
    </div>

    <!-- Photo Upload -->
    <div>
      <label class="block mb-1 text-gray-700 font-medium">
        {{ selectedIncidentId ? 'Upload Additional Photos' : 'Upload Photos' }}
      </label>
      <app-file-uploader
        (uploadSuccessfulEvent)="onImageUploaded($event)"
        (uploadErrorEvent)="onUploadError()"
      ></app-file-uploader>
    </div>

    <!-- Preview -->
    <div *ngIf="photoUrls.length > 0" class="grid grid-cols-3 gap-3 mt-4">
      <div *ngFor="let photo of photoUrls" class="relative group">
        <img
          [src]="photo"
          class="w-full h-32 object-cover rounded-lg border border-gray-300"
        />
        <button
          type="button"
          (click)="removePhoto(photo)"
          class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-80 hover:opacity-100"
        >
          &times;
        </button>
      </div>
    </div>

    <!-- Submit -->
    <button
      type="submit"
      [disabled]="submitting || (incidentForm.invalid && !selectedIncidentId)"
      class="w-full bg-green-700 text-white py-2 px-4 rounded-lg font-semibold shadow hover:bg-green-800 disabled:opacity-50 transition"
    >
      <span *ngIf="!submitting">
        {{ selectedIncidentId ? 'Add to Existing Incident' : 'Submit New Incident' }}
      </span>
      <div *ngIf="submitting" class="flex justify-center items-center space-x-2">
        <svg
          class="animate-spin h-5 w-5 text-white"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8v8z"
          ></path>
        </svg>
        <span>Submitting...</span>
      </div>
    </button>
  </form>

  <!-- Messages -->
  <p *ngIf="message" class="text-green-700 mt-4 text-sm font-medium">
    {{ message }}
  </p>
  <p *ngIf="error" class="text-red-600 mt-2 text-sm font-medium">{{ error }}</p>
</div>
